<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Checkout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    :root { --gap: 24px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; color:#111; }
    header { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid #eee; }
    header a { color:#111; text-decoration:none; font-weight:600; }
    header .cart-badge-wrap { margin-left:auto; }
    main.checkout { display:grid; grid-template-columns: 1fr 300px; gap:var(--gap); padding:16px; }
    @media (max-width: 900px) { main.checkout { grid-template-columns: 1fr; } }

    /* Left list (no images; bold, tidy) */
    #cart-items { list-style:none; padding:0; margin:0; }
    .cart-row { display:grid; grid-template-columns: 1fr auto; gap:12px; padding:12px 0; border-bottom:1px solid #eee; }
    .cart-title { margin:0 0 4px; font-size:16px; font-weight:700; letter-spacing:.2px; }
    .cart-sub { margin:0; color:#444; font-size:13px; }
    .row-right { display:flex; gap:10px; align-items:center; }
    .stepper { display:flex; gap:6px; align-items:center; }
    .stepper.sm button { width:24px; height:24px; }
    .stepper button { width:28px; height:28px; border:1px solid #ddd; border-radius:8px; background:#fff; }
    .line-subtotal { min-width:88px; text-align:right; font-variant-numeric: tabular-nums; }
    .remove-link { background:none; border:1px solid #ddd; padding:6px 10px; border-radius:8px; }
    .empty { color:#777; padding:10px 0; }

    /* Add-ons under base item, robust on all screens */
    .grouped .addon-list { margin-top:6px; display:grid; row-gap:8px; }
    .addon-row { display:grid; grid-template-columns: 1fr auto; align-items:center; column-gap:12px; }
    .addon-label.muted { color:#555; font-size:13px; }

    /* Right invoice */
    aside.cart-right { border:1px solid #eee; border-radius:12px; padding:14px; height:max-content; position:sticky; top:12px; }
    .muted { color:#666; }
    .pilltitle { font-weight:700; margin:6px 0 4px; }
    .inv-header { font-weight:800; margin:0 0 8px; font-size:18px; }
    .inv-list { display:grid; row-gap:6px; margin-bottom:10px; }
    .inv-row { display:flex; justify-content:space-between; align-items:baseline; }
    .inv-row small { color:#666; }

    .totals { display:grid; row-gap:8px; margin-top:6px; }
    .total-row { display:flex; justify-content:space-between; }
    .total-row strong { font-weight:700; }
    #proceed-btn { margin-top:12px; width:100%; padding:12px 12px; border-radius:10px; border:none; background:#111; color:#fff; }
    #proceed-btn:disabled { opacity:0.5; }

    /* Promo input: ≈3cm field + Apply Coupon */
    .promo-wrap { display:flex; gap:8px; align-items:center; margin:6px 0 2px; }
    #promo-input { inline-size:3cm; max-inline-size:3cm; padding:6px 8px; border:1px solid #ccc; border-radius:8px; }
    #promo-apply { padding:6px 10px; border-radius:8px; border:1px solid #111; background:#111; color:#fff; }
    #promo-error { color:#B00020; font-size:12px; margin-top:6px; line-height:1.2; min-height:14px; }
  </style>

  <!-- Accept ?cart= (base64url) to pre-hydrate localStorage gufa_cart -->
  <script>
  (function () {
    function fromBase64Url(s) { s = s.replace(/-/g, '+').replace(/_/g, '/'); while (s.length % 4) s += '='; return atob(s); }
    const qs = new URLSearchParams(location.search);
    const blob = qs.get('cart');
    if (blob && !localStorage.getItem('gufa_cart')) {
      try {
        const json = JSON.parse(fromBase64Url(blob));
        const bag = (json && typeof json === 'object')
          ? (json.items && typeof json.items === 'object' ? json.items : json)
          : {};
        localStorage.setItem('gufa_cart', JSON.stringify(bag));
      } catch {}
    }
  })();
  </script>

  <!-- Layout anchors expected by app.cart.js -->
  <script>
    window.CART_UI = {
      list: {
        items:'#cart-items',
        empty:'#cart-empty',
        /* count removed per request */
        subtotal:'#subtotal-amt',
        servicetax:'#servicetax-amt',
        total:'#total-amt',
        proceed:'#proceed-btn',
        invFood:'#inv-food',
        invAddons:'#inv-addons',
        promoLbl:'#promo-label',
        promoAmt:'#promo-amt',
        promoInput:'#promo-input',
        promoApply:'#promo-apply'
      },
      table: { body:'#cartBody', total:'#cartTotal' } // (unused fallback)
    };
  </script>
</head>
<body>

  <header>
    <a href="../" id="back-link">Menu</a>
    <div class="cart-badge-wrap">Cart: <span id="cart-count">0</span></div>
  </header>

  <main class="checkout">
    <section class="cart-left">
      <ul id="cart-items"></ul>
      <div id="cart-empty" class="empty">Your cart is empty.</div>
    </section>

    <aside class="cart-right">
      <div class="inv-header">Billing Invoice</div>

      <!-- Invoice breakdown -->
      <div class="pilltitle">Food Items</div>
      <div id="inv-food" class="inv-list"></div>

      <div class="pilltitle">Add-ons</div>
      <div id="inv-addons" class="inv-list"></div>

      <!-- Promo entry + line -->
      <div class="promo-wrap">
        <input id="promo-input" placeholder="Coupon ID"/>
        <button id="promo-apply">Apply Coupon</button>
      </div>

 <div class="totals">
  <div class="total-row"><span>Subtotal</span><span id="subtotal-amt">₹0</span></div>
  <div class="total-row">
    <span id="promo-label">Promotion (): none</span>
    <span id="promo-amt">− ₹0</span>
  </div>
  <div class="total-row"><span>Service Tax (5%)</span><span id="servicetax-amt">₹0</span></div>
  <div class="total-row" style="font-weight:700;"><span>Total</span><span id="total-amt">₹0</span></div>
</div>

      <button id="proceed-btn" disabled>Proceed</button>
    </aside>
  </main>

  <script>
    (function () {
      const a = document.getElementById('back-link');
      if (!a) return;
      a.href = new URL('../', location.href).toString();
    })();
  </script>

  <!-- Load order: store first, then cart UI -->
  <script src="./cart.store.js"></script>
  <script src="/admin/firease.js"></script>
  <script>
    (function () {
      // If your /admin/firease.js attaches firebase compat:
      // window.firebase.firestore() returns the db.
      // If it exposes a global db already, keep it.
      try {
        if (!window.db) {
          if (window.firebase && window.firebase.firestore) {
            window.db = window.firebase.firestore();
          }
        }
      } catch (e) {}
    })();
    
    window.CART_UI = window.CART_UI || {};
    window.CART_UI.list = Object.assign({
      items:      "#cart-items",
      empty:      "#cart-empty",
      count:      "#cart-count-text",
      subtotal:   "#inv-subtotal",
      servicetax: "#inv-servicetax",
      total:      "#inv-total",
      proceed:    "#btn-proceed",
      invFood:    "#inv-food",
      invAddons:  "#inv-addons",
      promoLbl:   "#inv-promo-label",
      promoAmt:   "#inv-promo-amount",
      promoInput: "#promo-input",
      promoApply: "#promo-apply"
    }, window.CART_UI.list || {});
  </script>
  <script src="./app.cart.js"></script>
</body>
</html>









